<template>
  <div @click="focusKey = ''" style="position: relative;">

    <Input v-model="searchText" class="form-control" type="text" placeholder="Search keys" style="width: 220px;margin: 0 0 10px 10px" />

    <Table stripe :columns="columns" :data="filterKeys" size="small" highlight-row
      @on-select-all="onSelectAll"
      @on-select-all-cancel="onSelectAllCancel"
      @on-select="onSelect"
      @on-select-cancel="onSelectCancel"
      >
      <template slot-scope="{ row }" slot="name" >
        <strong :key="row.name">{{ row.name }}</strong>
      </template>
      <template slot-scope="{ row }" slot="action">
        <router-link :to="{name: 'Detail', params: {key: row.name}}">
          <Icon type="ios-create-outline" size="30"/>
        </router-link>
      </template>
    </Table>

    <div class="toolbar-box">
      <div class="info">
        <strong>{{ dbsize }}</strong> keys in DB{{0}}; <strong>{{selectCount}}</strong> key selected
      </div>

      <div class="action">
        <Tooltip content="add" placement="top">
          <Icon type="md-add" size="22" @click="modalOfAdd = true"/>
          <Modal
            v-model="modalOfAdd"
            title="新增"
            @on-ok="modalOfAddOk"
            @on-cancel="modalOfAddCancel">
            <Input v-model="newKey" placeholder="Enter the new key." style="width: 300px">
              <span slot="prepend">Key</span>
            </Input>

            <Input v-model="newValue" type="textarea" :autosize="{minRows: 2,maxRows: 5}" placeholder="Enter the new value."/>

          </Modal>
        </Tooltip>
        <Divider type="vertical"/>
        <Tooltip content="refresh" placement="top">
          <Icon type="md-refresh" size="22" title="refresh" @click="onRefresh"/>
        </Tooltip>
        <Divider type="vertical"/>
        <Tooltip content="download" placement="top-end">
          <Icon type="md-download" size="22" />
        </Tooltip>
        <Divider type="vertical"/>
        <Tooltip content="delete" placement="top-end" @click.native="onDelete">
          <Icon type="md-trash" size="22" />
        </Tooltip>
        <Divider type="vertical"/>
        <Tooltip content="clear" placement="top-end">
          <Icon type="md-cube" size="22" />
        </Tooltip>
      </div>
      <!-- <Icon type="ios-refresh-circle-outline" /> -->
    </div>
  </div>

</template>

<script>
import { mapGetters, mapState } from 'vuex'
import redis from 'redis'
import { remote } from 'electron'

const { Menu, MenuItem } = remote
export default {
  data () {
    return {
      keys: [],
      searchText: '',
      focusKey: '',
      columns: [
        {
          type: 'selection',
          width: 60,
          align: 'center'
        }, {
          title: 'Key',
          key: 'name'
        // }, {
        //   title: 'Type',
        //   key: 'type'
        // }, {
        //   title: 'Value',
        //   key: 'value'
        }, {
          title: 'Action',
          slot: 'action',
          width: 80,
          align: 'center'
        }
      ],
      dbsize: 0,
      curPage: 0,
      modalOfAdd: false,
      newKey: '',
      newValue: '',
      selection: []
    }
  },
  computed: {
    ...mapGetters(['curConnection']),
    ...mapState(['curConnectionName']),
    filterKeys: function () {
      let tmp = this.keys.filter(key => key.toLowerCase().indexOf(this.searchText) > -1)
      return tmp.map(x => {
        return {name: x}
      })
    },
    nestedKeys: function () {
      let newKeys = {}
      return this.keys.forEach((key) => {
        let tmpKeys = key.split(':')
        if (tmpKeys.length === 1) {
          newKeys[tmpKeys[0]] = []
        } else {
          newKeys[tmpKeys] = []
        }
      })
    },
    selectCount: function () {
      return this.selection.length
    }
  },
  watch: {
    dbIndex: function (db) {
      this.fetchData()
    }
  },
  created () {
    // 组件创建完后获取数据，
    // 此时 data 已经被 observed 了
    this.dbIndex = this.$route.params.id
    this.searchText = this.$route.query.text || ''
    this.fetchData()
  },
  methods: {
    fetchData () {
      let client = redis.createClient(this.curConnection)
      console.log(client)
      console.log(client.connection_id)
      // client.list((err, reply) => {
      //   if (err) return console.log(err)
      //   console.log(reply)
      // })
      // client.client((err, reply) => {
      //   if (err) return console.log(err)
      //   console.log(reply)
      // })
      client.select(this.dbIndex, () => {
        client.keys('*', (err, keys) => {
          if (err) return console.log(err)
          this.keys = keys
        })

        client.dbsize((err, reply) => {
          if (err) return console.log(err)
          this.dbsize = reply
        })
        // client.scan(0, 'COUNT', '5', (err, reply) => {
        //   if (err) return console.log(err)
        //   console.log(reply)
        //   this.keys = reply[1]
        // })
      })
    },
    onRClick (key) {
      this.focusKey = key
      // let self = this
      const menu = new Menu()
      menu.append(new MenuItem({label: 'Copy', click () { console.log('item 1 clicked') }}))
      menu.append(new MenuItem({label: 'Delete', click () { console.log('item 1 clicked') }}))
      menu.append(new MenuItem({type: 'separator'}))
      menu.popup({window: remote.getCurrentWindow()})
    },
    modalOfAddOk () {
      if (this.newKey) {
        let client = this.redisClient(this.curConnection)
        client.select(this.dbIndex, () => {
          client.set(this.newKey, this.newValue, (err, keys) => {
            if (err) return console.log(err)
            this.keys = keys
          })
          console.log(client.connection_id)
        })
      }
    },
    modalOfAddCancel () {

    },
    onRefresh () {
      this.fetchData()
    },
    onDelete () {
      if (this.selection.length > 0) {
        let keys = this.selection.map(v => {
          return v.name
        })
        let client = this.redisClient({...this.curConnection, db: this.dbIndex})
        //  multi
        // let multi = client.multi()
        // this.selection.forEach((v, i) => {
        //   console.log(v.name)
        //   multi.del(v.name, (err, reply) => {
        //     if (err) {
        //       return console.log(err)
        //     }
        //   })
        // })
        // multi.exec((err, replies) => {
        //   if (err) console.log(err)
        //   console.log(replies) // 102, 3
        //   // client.quit()
        // })

        // batch
        let batch = client.batch()
        batch.del(...keys, (err, reply) => {
          if (err) console.log(err)
        })
        batch.exec((err, reply) => {
          if (err) console.log(err)
        })
      }
      this.fetchData()
    },
    changePage (page) {
      console.log(page)
    },
    onSelectAll () {
      this.selection = this.filterKeys.concat() // 深拷贝
    },
    onSelectAllCancel () {
      this.selection = []
    },
    onSelect (selection, row) {
      this.selection = selection
    },
    onSelectCancel (selection, row) {
      this.selection = selection
    }
  }
}
</script>

<style lang="css" scoped>
  .active {
    background: #409EFF !important
  }

</style>
